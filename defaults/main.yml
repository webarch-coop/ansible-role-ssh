# Copyright 2019-2023 Chris Croome
#
# This file is part of the Webarchitects OpenSSH Ansible role.
#
# The Webarchitects OpenSSH Ansible role is free software: you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version.
#
# The Webarchitects OpenSSH Ansible role is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License along with the Webarchitects OpenSSH Ansible role. If not, see <https://www.gnu.org/licenses/>.
---
# See also meta/argument_specs.yml

# Set ssh to true for the tasks in this role to be run
ssh: false

# Set ssh_audit to false to skip SSH auditing tasks
ssh_audit: true

# Set ssh_audit_fail to false to skip failing when config pass the ssh-audit policy
ssh_audit_fail: true

# https://man.openbsd.org/sshd_config#AllowAgentForwarding
ssh_allow_agent_forwarding: false

# https://man.openbsd.org/sshd_config#AllowGroups
ssh_allow_groups:
  - root
  - sudo
  # - chroot
  # - sftponly
  # - xenshell

# https://man.openbsd.org/sshd_config#AllowTcpForwarding
ssh_allow_tcp_forwarding: "no"

# https://man.openbsd.org/sshd_config#AuthenticationMethods
ssh_authentication_methods: publickey

# Strict checks, set this to false for checks to be allowed to fail
ssh_check_fail: true

# Directory under which users in the chroot will be chrooted to a directory
# matching their user name, for example /chroots/%u
# ssh_chroot_users_dir: /chroots

# If the ssh_ci_ips array is defined and not empty then a key pair will be
# generated in /root/.ssh/ci and the public key will be added to
# /root/.ssh/authorized_keys prefixed with a from="" containing the public key
# and the IP addresses:
# ssh_ci_ips:
#   - 192.168.0.1

# https://man.openbsd.org/sshd_config#Ciphers
ssh_ciphers:
  - "chacha20-poly1305@openssh.com"
  - "aes256-gcm@openssh.com"
  - "aes128-gcm@openssh.com"
  - aes256-ctr
  - aes192-ctr
  - aes128-ctr

# https://man.openbsd.org/sshd_config#DenyUsers
# ssh_deny_users:
#  - www-data

# Add SSH configuration for git user for GitLab
ssh_gitlab: false

# https://man.openbsd.org/sshd_config#HostKeyAlgorithms
# Comment the sk algos for OpenSSH < 8.4
ssh_host_key_algorithms:
  - "sk-ssh-ed25519@openssh.com"
  - "ssh-ed25519-cert-v01@openssh.com"
  - "sk-ssh-ed25519-cert-v01@openssh.com"
  - "rsa-sha2-256-cert-v01@openssh.com"
  - "rsa-sha2-512-cert-v01@openssh.com"
  - rsa-sha2-512
  - rsa-sha2-256
  - ssh-ed25519
  - "ssh-ed25519-cert-v01@openssh.com"

# https://man.openbsd.org/sshd_config#HostKey
ssh_host_keys:
  - name: rsa
    bits: 4096
    path: /etc/ssh/ssh_host_rsa_key
  - name: ed25519
    path: /etc/ssh/ssh_host_ed25519_key
  # Uncomment the following line for
  # https://infosec.mozilla.org/guidelines/openssh#modern-openssh-67
  # - name: ecdsa
  #   bits: 521
  #   path: /etc/ssh/ssh_host_ecdsa_key

# https://man.openbsd.org/sshd_config#KexAlgorithms
ssh_kex_algorithms:
  - "sntrup761x25519-sha512@openssh.com"
  - "sntrup4591761x25519-sha512@tinyssh.org"
  - curve25519-sha256
  - "curve25519-sha256@libssh.org"
  # - diffie-hellman-group14-sha256
  - diffie-hellman-group16-sha512
  - diffie-hellman-group18-sha512
  - diffie-hellman-group-exchange-sha256
  # Uncomment the following lines for
  # https://infosec.mozilla.org/guidelines/openssh#modern-openssh-67
  # - ecdh-sha2-nistp521
  # - ecdh-sha2-nistp384
  # - ecdh-sha2-nistp256

# https://man.openbsd.org/sshd_config#ListenAddress
ssh_listen_addresses:
  - 0.0.0.0

# ssh_localhost might need to be set to 127.0.0.1
ssh_localhost: localhost

# Enable generation of local configuration files
ssh_local_hosts: false

# Local directory for Host file
ssh_local_hosts_directory: ~/.ssh/ansible.d

# Path to the local Host file
ssh_local_hosts_file: "{{ ssh_local_hosts_directory }}/config"
# Use the following for one file per host
# ssh_local_hosts_file: "{{ ssh_local_hosts_directory }}/{{ inventory_hostname }}.host"

# Host name(s) to use in the local Host file
ssh_local_hosts_host: "{{ inventory_hostname_short }} {{ inventory_hostname }}"

# Hostname to use in the local Host file
ssh_local_hosts_hostname: "{{ ansible_default_ipv4.address | d() }}"

# UserKnownHostsFile to use in the local Host file
ssh_local_hosts_user_known_hosts_file: "{{ ssh_local_hosts_directory }}/known_hosts"
# Use the following for one file per host
# ssh_local_hosts_user_known_hosts_file: "{{ ssh_local_hosts_directory }}/{{ inventory_hostname }}.fingerprints"

# Port to use in the local Host file
ssh_local_hosts_port: "{{ ssh_ports[0] | default('22') }}"

# Path to a local README.md file
ssh_local_hosts_readme: "{{ ssh_local_hosts_directory }}/README.md"

# Template for each Host for the local README.md file
ssh_local_hosts_readme_host: |
  ## {{ inventory_hostname }}
  SSH server fingerprints for `{{ inventory_hostname }}` at `{{ ssh_local_hosts_hostname }}`:
  {% if ssh_audit_results is defined %}
  ```yml
  {{ ssh_audit_results.fingerprints | to_nice_yaml }}
  {% endif %}
  ```
  The above YAML can generated using `ssh-audit -j {{ ssh_local_hosts_hostname }} | jq .fingerprints | yq -P`

# https://man.openbsd.org/sshd_config#MACs
ssh_macs:
  - "hmac-sha2-256-etm@openssh.com"
  - "hmac-sha2-512-etm@openssh.com"
  - umac-128-etm@openssh.com
  # Uncomment the following lines for
  # https://infosec.mozilla.org/guidelines/openssh#modern-openssh-67
  # - hmac-sha2-512
  # - hmac-sha2-256
  # - "umac-128@openssh.com"

# https://man.openbsd.org/sshd_config#MACs
# Use `append` for `+`, `head` for `^` and `remove` for `-` to be used as a
# prefix to the array of MACs
# ssh_mac_list_strategy:

# https://man.openbsd.org/sshd_config#PasswordAuthentication
ssh_password_authentication: false

# https://man.openbsd.org/sshd_config#PermitRootLogin
ssh_permit_root_login: prohibit-password

# https://man.openbsd.org/sshd_config#Port
# The first port in this list will be used for the local host file
# to connect with another specify it on the command line
ssh_ports:
  - 22

# https://man.openbsd.org/sshd_config#PubkeyAuthentication
ssh_pubkey_authentication: true

# Generate a SSH keypair for the root user
ssh_root_keypair: true

# An array of IP addresses to scan for fingerprinting
ssh_scan_ip_addresses:
  - "{{ ansible_default_ipv4.address | d() }}"
  # - "{{ ansible_default_ipv6.address }}"

# Scan the keys available on the default IPv4 and IPv6 addresses
ssh_scan_keys: true

# Allow X11 forwarding
ssh_x11_forwarding: false

# GPG Agent Forwarding
# https://github.com/drduh/YubiKey-Guide#remote-machines-gpg-agent-forwarding
ssh_stream_local_bind_unlink: false

# SSH verify variables using the argument spec
ssh_verify: true
...
